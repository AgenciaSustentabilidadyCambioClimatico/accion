-# Variable para verificar si es una edicion desde mis instituciones
= simple_form_for [:admin,contribuyente_actor], remote: true, html: { autocomplete: :off } do |f|
  = f.input :temporal, as: :hidden, wrapper: false
  = f.input :flujo_id, as: :hidden, wrapper: false
  = f.input :contribuyente_id, as: :hidden, wrapper: false, input_html: { id: 'contribuyente_id' }

  = simple_nested_form_for [:admin,contribuyente_actor] do |snf|
    .row
      -unless @error_extra.blank?
        .col-12.mt-2
          .alert.alert-danger
            =@error_extra
      .col-12.mt-2
        .card
          .card-header
            %h5.no-margin
              = t(:agregar_nueva_institucion)
          .card-body{style: 'background-color: #e9ecef; padding: 0.25rem 9px 0.5rem'}
            .col-12.mt-2
              .card
                .card-header
                  %h5.no-margin
                    = t(:institucion) 
                .card-body
                  .row
                    .col-l-6.col-xl-3
                      %label.string.control-label
                        %abbr{title: :required}*
                        =t(:rut)
                      .row
                        .col-lg-8.desactivado
                          = f.input :rut, label: false, required: true, as: :string, input_html: { class: 'form-temporal-boton-guardar numero', readonly: !contribuyente_actor.contribuyente_id.nil?}
                        .col-lg-4.desactivado
                          = f.input :dv, label: false, required: true, input_html: { class: 'form-temporal-boton-guardar dv', readonly: !contribuyente_actor.contribuyente_id.nil? }
                    .col-lg-9.col-md-6.desactivado
                      = f.input :razon_social, label: t(:razón_social), required: true, input_html: { class: 'form-temporal-boton-guardar'}
                      .row
                        .col-lg-8.desactivado  
                          = f.input :tipo_institucion, collection: TipoContribuyente.__select, placeholder: "Seleccione tipo institución", input_html: { class: 'form-temporal-boton-guardar'} 
            .col-12.mt-2
              .card
                .card-header
                  %h5.no-margin
                    .row
                      .col-12.col-lg-10
                        =t(:actividad_económica)
                      .col-12-col-lg-2
                        = snf.link_to_add :actividad_economica_contribuyentes, class: 'ml-3', data: { target: "#contribuyente-actecos" } do
                          %i.fa.fa-plus-circle
                          = t(:agregar)
                .card-body.table
                  .row
                    .col-lg-12.col-md-6
                      %table#contribuyente-actecos.table.table-striped.m-0
                        %thead
                          %tr.fields
                            %th.codigo-acteco=t(:código_descripción)
                            %th
                        %tbody
                          = snf.fields_for :actividad_economica_contribuyentes, snf.object.actividad_economica_contribuyentes.select('DISTINCT actividad_economica_id'), :wrapper => false  do |actecos|
                            -style = '';
                            -style = "display: none;" if actecos.object.marked_for_destruction?
                            %tr.fields{style: style}
                              %td.no-padding
                                %div{class: actecos.object.errors[:actividad_economica].blank? ? '' : 'has-error'}
                                  =actecos.input :actividad_economica_id, collection: ActividadEconomica.__select, input_html:{ class: "form-control contribuyente-acteco form-temporal-boton-guardar required chosen-control  #{actecos.object.errors[:actividad_economica] == ["No puede estar en blanco"] ? 'border-error' : ''}", "data-placeholder"=>"Seleccione una actividad económica"}, label: false
                                  -unless actecos.object.errors[:actividad_economica].blank?
                                    %span.help-block
                                      =actecos.object.errors[:actividad_economica].first
                              %td.accion.no-padding.remove-row.desactivado
                                = actecos.link_to_remove do
                                  %i.fa.fa-times-circle.left.link-to-remove-row 
            .col-12.mt-2
              .card
                .card-header
                  %h5.no-margin
                    .row
                      .col-12.col-lg-10
                        =t(:establecimientos)
                      .col-12-col-lg-2
                        = snf.link_to_add :establecimiento_contribuyentes, class: 'ml-3', data: { target: "#establecimiento-actecos" } do
                          %i.fa.fa-plus-circle
                          =t(:agregar)
                .card-body.table
                  .row
                    .col-lg-12.col-md-6
                      %table#establecimiento-actecos.table.table-striped.m-0.table-responsive
                        %thead
                          %tr.fields
                            %th.casa-matriz=t(:c_matriz)
                            %th.direccion=t(:dirección)
                            %th.ciudad=t(:ciudad)
                            %th.region=t(:región)
                            %th.comuna=t(:comuna)
                            %th.accion
                        %tbody
                          = snf.fields_for :establecimiento_contribuyentes, :wrapper => false  do |establ|
                            -style = '';
                            -style = "display: none;" if establ.object.marked_for_destruction?
                            %tr.fields.desactivado{style: style}
                              %td.no-padding.casa-matriz=establ.input :casa_matriz, as: :boolean, label: false, input_html: { class: 'checkbox-casa-matriz'}
                              %td.no-padding.direccion=establ.input :direccion, input_html: { class: 'form-control establ-direccion form-temporal-boton-guardar'}, label: false
                              %td.no-padding.ciudad=establ.input :ciudad, input_html: { class: 'form-control letras establ-ciudad required form-temporal-boton-guardar'}, label: false
                              -regiones = Region.__select
                              -region_selec = establ.object.region_id.nil? ? regiones.first.last : establ.object.region_id
                              %td.no-padding.region
                                %div{class: establ.object.errors[:region].blank? ? '' : 'has-error'}
                                  =establ.select :region_id, regiones, {}, { class: 'form-control contribuyente-establecimiento-region contribuyente-acteco form-temporal-boton-guardar required chosen-control', "data-placeholder"=>"Seleccione una región"}
                                  -unless establ.object.errors[:region].blank?
                                    %span.help-block
                                      =establ.object.errors[:region].first
                              %td.no-padding.comuna
                                %div{class: establ.object.errors[:comuna].blank? ? '' : 'has-error'}
                                  =establ.select :comuna_id, Comuna.__select(nil,region_selec), {}, { class: 'form-control contribuyente-establecimiento-comuna contribuyente-acteco form-temporal-boton-guardar required chosen-control', "data-placeholder"=>"Seleccione una comuna" }
                                  -unless establ.object.errors[:comuna].blank?
                                    %span.help-block
                                      =establ.object.errors[:comuna].first
                              %td.accion.no-padding.remove-row
                                = establ.link_to_remove do
                                  %i.fa.fa-times-circle.left.link-to-remove-row
      .col-12.mt-2.text-right
        %button.btn.btn-primary#deshacer-contribuyente-button{type: :button, 'data-disable-with' => t(:volver_a_lista)}
          =t(:volver_a_lista)
        %button.btn.btn-primary.guarda-contribuyente-actor-button{type: :submit, disabled: :disabled, 'data-disable-with' => '<i class="fa fa-spinner fa-spin"></i> Guardando...'.html_safe}
          Agregar
:javascript

  $(document).ready(function(){
    __chosen_actecos();
    iniciarAutoNumeric();
    iniciarDigitoVerificador();
    htmlErrorToTooltip('top');
    nuevo_contribuyente_temporal_validaciones();

    

    // Manejador para el botón "Guardar Usuario"
    $(document).on('click', '.guarda-contribuyente-actor-button', function(e) {
      e.preventDefault();  // Evitar el envío del formulario por defecto

      var contribuyente_id = $('#contribuyente_id').val();
      var rut = $('#contribuyente_rut').val();
      var razon_social = $('#contribuyente_razon_social').val();
      var tipo_institucion = $('#contribuyente_tipo_institucion').val();
      var comuna = 'Talca';

      // Si deseas setear los valores en otros campos de tu formulario:
      $("#contribuyente_id_mapa_actores").val(contribuyente_id);
      $("#rut_contribuyente_mapa_actores").val(rut);
      $("#razon_social_contribuyente_mapa_actores").val(razon_social);
      $("#tipo_institucion_id_mapa_actores").val(tipo_institucion);
      $("#comuna_institucion_mapa_actores").val(comuna);
      $("#tipo_institucion_mapa_actores").val($('#contribuyente_tipo_institucion option:selected').text());   
      

      $('#buscar-contribuyente').modal("hide");
    });

  });
